---
date: 2026-02-11
topic: epub-tui-runtime-observability
author: Codex
---

# EPUB TUI 交互与可观测性脑暴

## What We're Building
为 `bilingual_book_maker` 增加统一的终端交互层（TUI/准 TUI），目标是让长时间 EPUB 翻译任务在终端中具备“低噪声、可追踪、可定位问题”的体验。

核心体验目标：
- 只显示必要状态：运行配置、章节进度、重试摘要、最终结果。
- 进度显示稳定：进度条始终在底部区域，不被普通日志冲散。
- 错误可诊断：终端显示状态码与 request_id；完整响应体写入日志文件。
- 断点续翻、自适应降档等关键机制必须有显式 UI 状态。

## Why This Approach
当前 CLI 输出已做收敛，但仍受 `tqdm + print` 混合输出影响。为获得稳定布局和更强可控性，应引入“事件驱动输出层”，将业务事件与展示解耦。

## Approaches

### Approach A: 继续沿用 `tqdm` + 规范日志（最小改动）

在现有实现上继续约束输出，严格使用 `tqdm.write`，减少 `print`，统一日志等级。

**Pros:**
- 改动最小，风险低。
- 与现有代码兼容性最好。

**Cons:**
- 难以保证复杂场景下布局稳定（并行、重试、多来源日志）。
- 不适合扩展状态面板、统计面板。

**Best when:** 只需小幅优化，不引入新交互层。

### Approach B: `rich.live` 仪表板式 TUI（推荐）

使用 `rich` 的 `Live`/`Layout` 渲染三块区域：顶部运行状态、中部滚动事件、底部进度条（单条或多条）。业务层只发事件，UI 层负责渲染。

**Pros:**
- 显著提升可读性，能稳定控制“进度条在底部”。
- 复杂度适中，落地快于全量 Textual。
- 可平滑保留纯文本 fallback。

**Cons:**
- 需要重构日志输出路径为事件流。
- 并发事件聚合需要额外设计。

**Best when:** 需要尽快得到稳定的终端交互体验。

### Approach C: `textual` 全屏交互式应用（重型）

构建完整全屏 TUI（多面板、快捷键、筛选、详情展开、重试控制）。

**Pros:**
- 可扩展性与交互性最强。
- 后续可加入暂停/恢复、日志检索等操作能力。

**Cons:**
- 开发与维护成本高，侵入性大。
- 首版周期长，回归范围大。

**Best when:** 已确认长期投入终端产品化体验。

## 推荐方案
推荐 **Approach B（`rich.live` 仪表板式 TUI）**，并采用“可回退”策略：
- 默认启用新 UI（或通过开关启用）。
- 保留纯文本模式（`--no-tui`）用于 CI/重定向日志场景。

## Key Decisions
- 决策 1：首版范围聚焦 EPUB 主流程。  
  理由：你当前痛点主要集中在 EPUB 长任务，先解决最核心路径。

- 决策 2：引入统一事件模型（`RUN/CHAPTER/ADAPTIVE/WARN/DONE`）。  
  理由：业务层与展示层解耦，减少后续改动成本。

- 决策 3：`WARN` 统一展示 `status_code + request_id + retry_in`。  
  理由：满足快速诊断，同时避免终端刷响应体。

- 决策 4：底部进度区唯一来源，禁止业务代码直接操作多进度条。  
  理由：避免“双进度条”与“进度失效”。

- 决策 5：完整错误载荷落盘到 `log/provider_error.log`。  
  理由：终端简洁，排障有据可查。

## 初步规范（MVP）

### 1) UI 布局
- 顶部：运行摘要（模型、resume、parallel、accumulated、adaptive、context）。
- 中部：事件流（最近 N 条，按级别着色）。
- 底部：进度条区（串行显示 Segments，并行显示 Chapters）。

### 2) 事件规范
- `INFO`：阶段切换、章节开始、完成摘要。
- `ADAPTIVE`：预算降档/恢复。
- `WARN`：重试事件，格式固定：`status=<code> request_id=<id> retry=<sec>`。
- `ERROR`：不可恢复错误。

### 3) 业务约束
- 业务代码禁止直接 `print` 用户可见日志，统一走 UI 事件发射器。
- 多线程场景必须通过线程安全队列合并事件。
- 进度更新必须“处理完成后再推进”，不得预推进。

### 4) 开关与兼容
- 新增 `--no-tui`（关闭 TUI，回退纯文本）。
- 新增 `--ui-refresh-ms`（可选，默认 100~200ms）。
- 保持现有参数兼容，不改变翻译逻辑语义。

## Open Questions
- 首版是否仅覆盖 EPUB，还是同步覆盖 TXT/PDF/SRT？
- 是否需要在首版加入交互控制（例如按键暂停/退出）？
- 默认是否启用 TUI，还是通过 `--tui` 显式启用？

## Next Steps
1. 将本脑暴转为实施计划（模块拆分、文件清单、测试清单）。
2. 定义事件总线接口与 UI 渲染器边界。
3. 先做 EPUB 路径 MVP，再扩展到其他 loader。

